## Installation
- Prepare OpenVPN server
  - use scripts in [vpn-server](./vpn-server) direcotry
- `prepare_host.yml`
  - Installs Docker
  - sets up portainer
  - sets up openvpn connection
  - sets hostnamee to fully qualified domain name
- Manually adopt the host to the FreeIPA domain
- Set up replica container
  - Manually create A record in IPA DNS to avoid connecheck issues when setting up replica
  - Use `setup_replica.yml`
- Delete options file which contains password needed for creation of replica
  - `/var/docker/replica/ipa-replica-install-options`
- Make sure replica was successfully created
- Create svc_mail user
- `cloud.yml`
  - Sets up replica container
  - Sets up postfix, dovecot, rspamd containers
- Fix issue with permissions and postfix not being able to access authentication socket `chmod a+rx /var/docker/mail`
- Set up reverse DNS
- Set up DNS records
  - MX record to point to Mail server
  - DMARC record: is a TXT record in form _dmarc.domain.com with value `v=DMARC1; p=reject; adkim=r; aspf=r; sp=reject`. This indicates that only mail servers of this domain are authorized to send mail for this domain.
  - DKIM record: TXT record `dkim._domainkey.domain.com` . Its value will be generated by rspamd container on first run and can be found in this containers logs
- Make sure timezone in postfix container is correct as this may cause issues with some mailservers

## Mail Routing
### Simple mail delivery
Users can have mailbox user@domain. Mail should be delivered to dovecot so the user can read the mail in their mailbox
### Delivery to external mailboxes
*Not working*
If a user has a mail which points to an external mail server e.g. user@gmail.com, when mail is sent to user@domain the mail server should forward it to user@gmail.com
### Group Delivery
From internal mail addresses mail can be sent to group@domain it will then be delivered to all users of these groups. The mail attribute in FreeIPA is used as destination, so it can also be sent to external addresses.

## Setup
### Difficulties when setting up replica
1. The master needs to be able to directly access the replica and not just vice versa
  1. Create a docker macvlan network, which attaches the containers directly to the network `sudo docker network create -d macvlan --subnet=10.13.10.0/24 --gateway=10.13.10.1 -o parent=tap0 macvlan`




### Setup DNS
1. Setup mail.domain in dns
2. Setup reverse DNS
3. Make sure correct timezone is set
4. Add Dkim record and dmarc record to domain see https://www.c0ffee.net/blog/mail-server-guide/ for more
5. add replica to ipaservers host-group


## Linode with full disk encryption
Follow [this guide](https://www.linode.com/docs/tools-reference/custom-kernels-distros/install-a-custom-distribution-on-a-linode/)

Use this command to download ubuntu server:
`curl https://releases.ubuntu.com/20.04.1/ubuntu-20.04.1-live-server-amd64.iso | dd of=/dev/sda`

## Design
### Directories
- /var/docker directory for all docker volumes
  - /postfix/config  configuration directory for postfix
  - /mail data shared between multiple mail processes
    - /ssl directory for ssl certificates and dhparams
  - /rspamd  rspamd configuration and dkim keys

## Issues
make sure docker container can resolve MX entries
Disable chroot in master.cf
Debugging postfix https://access.redhat.com/solutions/70539

#### Freeipa ports list
- "127.0.0.1:53:53/udp"
- "127.0.0.1:53:53"
- "127.0.0.1:80:80"
- "127.0.0.1:443:443"
- "127.0.0.1:389:389"
- "127.0.0.1:636:636"
- "127.0.0.1:88:88"
- "127.0.0.1:464:464"
- "127.0.0.1:88:88/udp"
- "127.0.0.1:464:464/udp"
- "127.0.0.1:123:123/udp"
