- name: create macvlan network
  docker_network:
    name: "macvlan"
    driver: macvlan
    ipam_config:
      - subnet: "{{local_subnet}}"
        gateway: "{{local_subnet_gateway}}"

- name: create replica directory
  file:
    path: "{{ freeipa_dir }}"
    state: directory
  when: replica

- name: create tempfile for password
  tempfile:
    state: file
  register: tempfile

- name: write password to tempfile
  lineinfile:
    path: "{{tempfile.path}}"
    line: "{{ipa_admin_user_password}}"


- name: start freeipa replica docker
  docker_container:
    name: replica
    image: "freeipa/freeipa-server:centos-8"
    state: started
    detach: true
    recreate: no
    restart_policy: no
    hostname: "{{replica_name}}"
    sysctls: "net.ipv6.conf.all.disable_ipv6=0"
    dns_servers: "{{dns_server}}"
    env:
      DEBUG_NO_EXIT: "1"
      DEBUG_TRACE: "1"
    networks:
      - name: primary
        ipv4_address: "172.18.0.3/16"
      - name: macvlan
    published_ports:
      - "127.0.0.1:443:443"
      - "127.0.0.1:53:53"
    volumes:
      - "/sys/fs/cgroup:/sys/fs/cgroup:ro"
      - "{{freeipa_dir}}:/data:Z"
      - "{{tempfile.path}}:/password:ro"
    command: "ipa-replica-install -U --no-ntp -P {{ipa_admin_user}} -w $(cat /password)"

- name: remove password file
  file:
      path: "{{tempfile.path}}" # required. Path to the file being managed.
      state: absent
